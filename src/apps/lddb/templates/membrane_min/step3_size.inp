* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) on Aug, 19. 2013.
* DETERMINE THE SYSTEM SIZE IN XY 
*

! Read topology and parameter files
stream toppar.str

! Read PSF and Coordinates
open read unit 10 card name step1_pdbreader.psf
read psf  unit 10 card

open read unit 10 card name step2_orient.crd
read coor unit 10 card

! Protein area
stream step2_protein_area.str

! estimate protein extent along Z axis
coor stat sele .not. hydrogen end
calc protZmax = ?zmax
calc protZmin = ?zmin

set BOXTYPE = rect
set Alpha = 90.0
set Beta  = 90.0
set Gamma = 90.0

! Areas between -20 and 20 along the Z axis are only meaningful
define core sele ( ( prop Z .ge. -20.0 ) .and. ( prop Z .le. 20.0 ) ) .and. .not. hydrogen end
calc xmax = ?xmax
calc xmin = ?xmin
calc ymax = ?ymax
calc ymin = ?ymin

! in the case that a protein is not bound to membranes 
! a small number of 0.01 is assigned due to numerical manipulation
if ?nsel .eq. 0 then
calc xmax = 0.01
calc xmin = 0.01
calc ymax = 0.01
calc ymin = 0.01
endif

! Lipid area
calc liparea = 68.3 ! A**2 

! Determine system size based on number of lipid layers between 
! proteins in periodic boundary condition.
calc nlayer = 1.5
calc lipradius = sqrt ( @liparea / ?pi )
calc lipextent = @lipradius * 2.0 * @nlayer
if xmax .ge. -@xmin calc initX = (  @xmax + @lipextent ) * 2.0
if xmax .lt. -@xmin calc initX = ( -@xmin + @lipextent ) * 2.0
if ymax .ge. -@ymin calc initY = (  @ymax + @lipextent ) * 2.0
if ymax .lt. -@ymin calc initY = ( -@ymin + @lipextent ) * 2.0

calc nliptop = int ( ( @initX * @initY - @toparea ) / @liparea ) + 1
calc nlipbot = int ( ( @initX * @initY - @botarea ) / @liparea ) + 1

calc liptoparea = @nliptop * @liparea 
calc lipbotarea = @nlipbot * @liparea 

calc LXYtop = sqrt( @liptoparea + @toparea )
calc LXYbot = sqrt( @lipbotarea + @botarea )
calc LXY    = ( @LXYtop + @LXYbot ) / 2

! allow 5% difference along X and Y
calc XvsY = 1
if XvsY .lt. 1.05 if XvsY .gt. 0.95 calc XvsY = 1
calc B = sqrt( @LXY * @LXY / @XvsY )
calc A = @XvsY * @B

set XTLtype = ORTHorhombic
if A .eq. @B set XTLtype = TETRagonal

! Z value determination
calc lipboxZhalf = 20

! water layer from protein top and bottom
calc wboxZ = 15

if protZmax .lt. 20  set protZmax =  20
if protZmin .gt. -20 set protZmin = -20
calc propzup = @protZmax + @wboxZ
calc propzdn = @protZmin - @wboxZ

calc watZup = 0
calc watZdn = 0
if propzup .ge.  @lipboxZhalf calc watZup =   @propzup - @lipboxZhalf
if propzdn .lt. -@lipboxZhalf calc watZdn = - @propzdn - @lipboxZhalf

calc boxsizeZ = @lipboxZhalf * 2 + @watZup + @watZdn
calc zcen = ( @watZup - @watZdn ) / 2.0

calc watboxZ = @watZup
if watZup .lt. @watZdn calc watboxZ = @watZdn

stream step3_nlipids_upper.prm
stream step3_nlipids_lower.prm

calc ncharge = ?cgtot 
calc ncharge = @ncharge + -1 * ( @ndlpatop + @ndlpabot ) 
calc ncharge = @ncharge + -1 * ( @nsapgtop + @nsapgbot ) 
calc ncharge = @ncharge + -1 * ( @nslpgtop + @nslpgbot ) 
calc ncharge = @ncharge + -1 * ( @nplpgtop + @nplpgbot ) 
calc ncharge = @ncharge + -1 * ( @ndlpgtop + @ndlpgbot ) 
calc ncharge = @ncharge + -1 * ( @ndlpstop + @ndlpsbot ) 
calc ncharge = @ncharge + -1 * ( @ndmpatop + @ndmpabot ) 
calc ncharge = @ncharge + -1 * ( @ndmpgtop + @ndmpgbot ) 
calc ncharge = @ncharge + -1 * ( @ndmpstop + @ndmpsbot ) 
calc ncharge = @ncharge + -1 * ( @ndppatop + @ndppabot ) 
calc ncharge = @ncharge + -1 * ( @ndppgtop + @ndppgbot ) 
calc ncharge = @ncharge + -1 * ( @ndppstop + @ndppsbot ) 
calc ncharge = @ncharge + -1 * ( @ndopatop + @ndopabot ) 
calc ncharge = @ncharge + -1 * ( @ndopgtop + @ndopgbot ) 
calc ncharge = @ncharge + -1 * ( @ndopstop + @ndopsbot ) 
calc ncharge = @ncharge + -1 * ( @npopatop + @npopabot ) 
calc ncharge = @ncharge + -1 * ( @npopgtop + @npopgbot ) 
calc ncharge = @ncharge + -1 * ( @npopstop + @npopsbot ) 
calc ncharge = @ncharge + -1 * ( @ndspatop + @ndspabot ) 
calc ncharge = @ncharge + -1 * ( @ndspgtop + @ndspgbot ) 
calc ncharge = @ncharge + -1 * ( @ndspstop + @ndspsbot ) 
calc ncharge = @ncharge + -1 * ( @nsapstop + @nsapsbot ) 
calc ncharge = @ncharge + -1 * ( @nslpstop + @nslpsbot ) 
calc ncharge = @ncharge + -1 * ( @nplpstop + @nplpsbot ) 
calc ncharge = @ncharge + -1 * ( @ndxpatop + @ndxpabot ) 
calc ncharge = @ncharge + -1 * ( @ndxpgtop + @ndxpgbot ) 
calc ncharge = @ncharge + -1 * ( @ndgpatop + @ndgpabot ) 
calc ncharge = @ncharge + -1 * ( @ndgpgtop + @ndgpgbot ) 
calc ncharge = @ncharge + -1 * ( @ndepatop + @ndepabot ) 
calc ncharge = @ncharge + -1 * ( @ndepgtop + @ndepgbot ) 
calc ncharge = @ncharge + -1 * ( @ndnpatop + @ndnpabot ) 
calc ncharge = @ncharge + -1 * ( @ndnpgtop + @ndnpgbot ) 
calc ncharge = @ncharge + -1 * ( @nsapitop + @nsapibot ) 
calc ncharge = @ncharge + -3 * ( @nsapi13top + @nsapi13bot ) 
calc ncharge = @ncharge + -3 * ( @nsapi14top + @nsapi14bot ) 
calc ncharge = @ncharge + -3 * ( @nsapi15top + @nsapi15bot ) 
calc ncharge = @ncharge + -4 * ( @nsapi24top + @nsapi24bot ) 
calc ncharge = @ncharge + -4 * ( @nsapi25top + @nsapi25bot ) 
calc ncharge = @ncharge + -6 * ( @nsapi33top + @nsapi33bot ) 
calc ncharge = @ncharge + -6 * ( @nsapi34top + @nsapi34bot ) 
calc ncharge = @ncharge + -6 * ( @nsapi35top + @nsapi35bot ) 
calc ncharge = @ncharge + -1 * ( @ndmpitop + @ndmpibot ) 
calc ncharge = @ncharge + -3 * ( @ndmpi13top + @ndmpi13bot ) 
calc ncharge = @ncharge + -3 * ( @ndmpi14top + @ndmpi14bot ) 
calc ncharge = @ncharge + -3 * ( @ndmpi15top + @ndmpi15bot ) 
calc ncharge = @ncharge + -4 * ( @ndmpi24top + @ndmpi24bot ) 
calc ncharge = @ncharge + -4 * ( @ndmpi25top + @ndmpi25bot ) 
calc ncharge = @ncharge + -6 * ( @ndmpi33top + @ndmpi33bot ) 
calc ncharge = @ncharge + -6 * ( @ndmpi34top + @ndmpi34bot ) 
calc ncharge = @ncharge + -6 * ( @ndmpi35top + @ndmpi35bot ) 
calc ncharge = @ncharge + -1 * ( @npopitop + @npopibot ) 
calc ncharge = @ncharge + -3 * ( @npopi13top + @npopi13bot ) 
calc ncharge = @ncharge + -3 * ( @npopi14top + @npopi14bot ) 
calc ncharge = @ncharge + -3 * ( @npopi15top + @npopi15bot ) 
calc ncharge = @ncharge + -4 * ( @npopi24top + @npopi24bot ) 
calc ncharge = @ncharge + -4 * ( @npopi25top + @npopi25bot ) 
calc ncharge = @ncharge + -6 * ( @npopi33top + @npopi33bot ) 
calc ncharge = @ncharge + -6 * ( @npopi34top + @npopi34bot ) 
calc ncharge = @ncharge + -6 * ( @npopi35top + @npopi35bot ) 
calc ncharge = @ncharge + -1 * ( @ntocl1top + @ntocl1bot ) 
calc ncharge = @ncharge + -2 * ( @ntocl2top + @ntocl2bot ) 
calc ncharge = @ncharge + -1 * ( @ntmcl1top + @ntmcl1bot ) 
calc ncharge = @ncharge + -2 * ( @ntmcl2top + @ntmcl2bot ) 
calc ncharge = @ncharge + -1 * ( @ntlcl1top + @ntlcl1bot ) 
calc ncharge = @ncharge + -2 * ( @ntlcl2top + @ntlcl2bot ) 
calc ncharge = @ncharge + -1 * ( @ntxcl1top + @ntxcl1bot ) 
calc ncharge = @ncharge + -2 * ( @ntxcl2top + @ntxcl2bot ) 
calc ncharge = @ncharge + -1 * ( @npmcl1top + @npmcl1bot ) 
calc ncharge = @ncharge + -2 * ( @npmcl2top + @npmcl2bot ) 
calc ncharge = @ncharge + -1 * ( @npmpgtop + @npmpgbot ) 
calc ncharge = @ncharge + -1 * ( @npspgtop + @npspgbot ) 
calc ncharge = @ncharge + -1 * ( @nsdpgtop + @nsdpgbot ) 
calc ncharge = @ncharge + -1 * ( @nsopgtop + @nsopgbot ) 
calc ncharge = @ncharge + -1 * ( @ndapgtop + @ndapgbot ) 
calc ncharge = @ncharge + -1 * ( @nsdpstop + @nsdpsbot ) 
calc ncharge = @ncharge + -1 * ( @nsdpatop + @nsdpabot ) 
calc ncharge = @ncharge + -1 * ( @nsopstop + @nsopsbot ) 
calc ncharge = @ncharge + -1 * ( @nsopatop + @nsopabot ) 
calc ncharge = @ncharge + -1 * ( @ndapatop + @ndapabot ) 
calc ncharge = @ncharge + -1 * ( @nsapatop + @nsapabot ) 
calc ncharge = @ncharge + -1 * ( @nslpatop + @nslpabot ) 
calc ncharge = @ncharge + -1 * ( @nplpatop + @nplpabot ) 
calc ncharge = @ncharge + -1 * ( @ndapstop + @ndapsbot )

open write card  unit 51 name step3_size.str
write title unit 51
* set BOXtype  = @BOXtype
* set XTLtype  = @XTLtype
* set A        = @A
* set B        = @B
* set C        = @boxsizez
* set Alpha    = @Alpha
* set Beta     = @Beta
* set Gamma    = @Gamma
* set Zcen     = @zcen
* set NLIPTOP  = @nliptop
* set NLIPBOT  = @nlipbot
* set watboxZ  = @watboxZ
* set ncharge  = @ncharge
* set LIPTYPE  = popc
*

stop